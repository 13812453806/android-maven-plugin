<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2014-07-24
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20140724" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Android Maven Plugin &#x2013; CPD Results</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarEnabled">
          
                
                    
                

    <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
                <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
                
                                <ul class="nav">
                          <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="index.html"  title="Introduction">Introduction</a>
</li>
                  
                      <li>      <a href="plugin-info.html"  title="Goals">Goals</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li class="dropdown-submenu">
                                      <a href="project-info.html"  title="Project Information">Project Information</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="index.html"  title="About">About</a>
</li>
                                  <li>      <a href="plugin-management.html"  title="Plugin Management">Plugin Management</a>
</li>
                                  <li>      <a href="distribution-management.html"  title="Distribution Management">Distribution Management</a>
</li>
                                  <li>      <a href="dependency-info.html"  title="Dependency Information">Dependency Information</a>
</li>
                                  <li>      <a href="source-repository.html"  title="Source Repository">Source Repository</a>
</li>
                                  <li>      <a href="mail-lists.html"  title="Mailing Lists">Mailing Lists</a>
</li>
                                  <li>      <a href="issue-tracking.html"  title="Issue Tracking">Issue Tracking</a>
</li>
                                  <li>      <a href="integration.html"  title="Continuous Integration">Continuous Integration</a>
</li>
                                  <li>      <a href="plugins.html"  title="Project Plugins">Project Plugins</a>
</li>
                                  <li>      <a href="license.html"  title="Project License">Project License</a>
</li>
                                  <li>      <a href="dependency-management.html"  title="Dependency Management">Dependency Management</a>
</li>
                                  <li>      <a href="team-list.html"  title="Project Team">Project Team</a>
</li>
                                  <li>      <a href="project-summary.html"  title="Project Summary">Project Summary</a>
</li>
                                  <li>      <a href="dependencies.html"  title="Dependencies">Dependencies</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="project-reports.html"  title="Project Reports">Project Reports</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="plugin-info.html"  title="Plugin Documentation">Plugin Documentation</a>
</li>
                                  <li>      <a href="xref-test/index.html"  title="Test Source Xref">Test Source Xref</a>
</li>
                                  <li>      <a href="xref/index.html"  title="Source Xref">Source Xref</a>
</li>
                                  <li>      <a href="checkstyle.html"  title="Checkstyle">Checkstyle</a>
</li>
                                  <li>      <a href="pmd.html"  title="PMD">PMD</a>
</li>
                                  <li>      <a href="cpd.html"  title="CPD">CPD</a>
</li>
                                  <li>      <a href="apidocs/index.html"  title="JavaDocs">JavaDocs</a>
</li>
                                  <li>      <a href="testapidocs/index.html"  title="Test JavaDocs">Test JavaDocs</a>
</li>
                                  <li>      <a href="surefire-report.html"  title="Surefire Report">Surefire Report</a>
</li>
                                  <li>      <a href="cobertura/index.html"  title="Cobertura Test Coverage">Cobertura Test Coverage</a>
</li>
                                  <li>      <a href="findbugs.html"  title="FindBugs Report">FindBugs Report</a>
</li>
                              </ul>
            </li>
                          </ul>
      </li>
                  </ul>
          
          
          
                   
                      </div>
          
        </div>
      </div>
    </div>
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Android Maven Plugin - android-maven-plugin</h2>
                </div>
                      </div>
        <div class="pull-right">              <div id="bannerRight">
                                                                                                <img src="" />
                </div>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2014-07-24</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 3.9.0-rc.3</li>
                      
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Overview</li>
                                
      <li>
    
                          <a href="index.html" title="Introduction">
          <i class="none"></i>
        Introduction</a>
            </li>
                  
      <li>
    
                          <a href="plugin-info.html" title="Goals">
          <i class="none"></i>
        Goals</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                            
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                                                                                                                                                                  
      <li>
    
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-down"></i>
        Project Reports</a>
                    <ul class="nav nav-list">
                      
      <li>
    
                          <a href="plugin-info.html" title="Plugin Documentation">
          <i class="none"></i>
        Plugin Documentation</a>
            </li>
                      
      <li>
    
                          <a href="xref-test/index.html" title="Test Source Xref">
          <i class="none"></i>
        Test Source Xref</a>
            </li>
                      
      <li>
    
                          <a href="xref/index.html" title="Source Xref">
          <i class="none"></i>
        Source Xref</a>
            </li>
                      
      <li>
    
                          <a href="checkstyle.html" title="Checkstyle">
          <i class="none"></i>
        Checkstyle</a>
            </li>
                      
      <li>
    
                          <a href="pmd.html" title="PMD">
          <i class="none"></i>
        PMD</a>
            </li>
                      
      <li class="active">
    
            <a href="#"><i class="none"></i>CPD</a>
          </li>
                      
      <li>
    
                          <a href="apidocs/index.html" title="JavaDocs">
          <i class="none"></i>
        JavaDocs</a>
            </li>
                      
      <li>
    
                          <a href="testapidocs/index.html" title="Test JavaDocs">
          <i class="none"></i>
        Test JavaDocs</a>
            </li>
                      
      <li>
    
                          <a href="surefire-report.html" title="Surefire Report">
          <i class="none"></i>
        Surefire Report</a>
            </li>
                      
      <li>
    
                          <a href="cobertura/index.html" title="Cobertura Test Coverage">
          <i class="none"></i>
        Cobertura Test Coverage</a>
            </li>
                      
      <li>
    
                          <a href="findbugs.html" title="FindBugs Report">
          <i class="none"></i>
        FindBugs Report</a>
            </li>
              </ul>
        </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <div class="section">
<h2><a name="CPD_Results"></a>CPD Results</h2>
<p>The following document contains the results of PMD's  <a class="externalLink" href="http://pmd.sourceforge.net/cpd.html">CPD</a> 5.0.5.</p></div>
<div class="section">
<h2><a name="Duplications"></a>Duplications</h2>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L563">563</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L501">501</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    }

    /**
     * AndroidTestRunListener produces a nice output for the log for the test run as well as an xml file compatible with
     * the junit xml report file format understood by many tools.
     * &lt;p/&gt;
     * It will do so for each device/emulator the tests run on.
     */
    public class AndroidTestRunListener implements ITestRunListener
    {
        private static final String SCREENSHOT_SUFFIX = &quot;_screenshot.png&quot;;

        /**
         * the indent used in the log to group items that belong together visually *
         */
        private static final String INDENT = &quot;  &quot;;

        /**
         * Junit report schema documentation is sparse. Here are some hints
         * 
         * @see &quot;http://mail-archives.apache.org/mod_mbox/ ant-dev/200902.mbox/%3
         *      Cdffc72020902241548l4316d645w2e98caf5f0aac770
         * @mail.gmail.com%3E&quot;
         * @see &quot;http://junitpdfreport.sourceforge.net/managedcontent/PdfTranslation&quot;
         */
        private static final String TAG_TESTSUITES = &quot;testsuites&quot;;

        private static final String TAG_TESTSUITE = &quot;testsuite&quot;;
        private static final String ATTR_TESTSUITE_ERRORS = &quot;errors&quot;;
        private static final String ATTR_TESTSUITE_FAILURES = &quot;failures&quot;;
        private static final String ATTR_TESTSUITE_HOSTNAME = &quot;hostname&quot;;
        private static final String ATTR_TESTSUITE_NAME = &quot;name&quot;;
        private static final String ATTR_TESTSUITE_TESTS = &quot;tests&quot;;
        private static final String ATTR_TESTSUITE_TIME = &quot;time&quot;;
        private static final String ATTR_TESTSUITE_TIMESTAMP = &quot;timestamp&quot;;

        private static final String TAG_PROPERTIES = &quot;properties&quot;;
        private static final String TAG_PROPERTY = &quot;property&quot;;
        private static final String ATTR_PROPERTY_NAME = &quot;name&quot;;
        private static final String ATTR_PROPERTY_VALUE = &quot;value&quot;;

        private static final String TAG_TESTCASE = &quot;testcase&quot;;
        private static final String ATTR_TESTCASE_NAME = &quot;name&quot;;
        private static final String ATTR_TESTCASE_CLASSNAME = &quot;classname&quot;;
        private static final String ATTR_TESTCASE_TIME = &quot;time&quot;;

        private static final String TAG_ERROR = &quot;error&quot;;
        private static final String TAG_FAILURE = &quot;failure&quot;;
        private static final String ATTR_MESSAGE = &quot;message&quot;;
        private static final String ATTR_TYPE = &quot;type&quot;;

        /**
         * time format for the output of milliseconds in seconds in the xml file *
         */
        private final NumberFormat timeFormatter = new DecimalFormat( &quot;#0.0000&quot; );

        private int testCount = 0;
        private int testRunCount = 0;
        private int testFailureCount = 0;
        private int testErrorCount = 0;
        private String testRunFailureCause = null;

        private final MavenProject project;
        /**
         * the emulator or device we are running the tests on *
         */
        private final IDevice device;

        private final String deviceLogLinePrefix;

        // junit xml report related fields
        private Document junitReport;
        private Node testSuiteNode;

        /**
         * node for the current test case for junit report
         */
        private Node currentTestCaseNode;
        /**
         * start time of current test case in millis, reset with each test start
         */
        private long currentTestCaseStartTime;

        // we track if we have problems and then report upstream
        private boolean threwException = false;
        private final StringBuilder exceptionMessages = new StringBuilder();

        /**
         * Create a new test run listener.
         * 
         * @param project
         *            the test project.
         * @param device
         *            the device on which test is executed.
         */
        public AndroidTestRunListener( MavenProject project, IDevice device )
        {
            this.project = project;
            this.device = device;
            this.deviceLogLinePrefix = DeviceHelper.getDeviceLogLinePrefix( device );
        }

        @Override
        public void testRunStarted( String runName, int tCount )
        {

            this.testCount = tCount;
            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run started: &quot; + runName + &quot;, &quot; + testCount + &quot; tests:&quot; );

            if ( parsedCreateReport )
            {
                try
                {
                    DocumentBuilderFactory fact = DocumentBuilderFactory.newInstance();
                    DocumentBuilder parser = null;
                    parser = fact.newDocumentBuilder();
                    junitReport = parser.newDocument();
                    Node testSuitesNode = junitReport.createElement( TAG_TESTSUITES );
                    junitReport.appendChild( testSuitesNode );
                    testSuiteNode = junitReport.createElement( TAG_TESTSUITE );
                    NamedNodeMap testSuiteAttributes = testSuiteNode.getAttributes();
                    Attr nameAttr = junitReport.createAttribute( ATTR_TESTSUITE_NAME );
                    nameAttr.setValue( runName );
                    testSuiteAttributes.setNamedItem( nameAttr );
                    Attr hostnameAttr = junitReport.createAttribute( ATTR_TESTSUITE_HOSTNAME );
                    hostnameAttr.setValue( DeviceHelper.getDescriptiveName( device ) );
                    testSuiteAttributes.setNamedItem( hostnameAttr );
                    Node propertiesNode = junitReport.createElement( TAG_PROPERTIES );
                    Node propertyNode;
                    NamedNodeMap propertyAttributes;
                    Attr propNameAttr;
                    Attr propValueAttr;
                    for ( Map.Entry&lt; Object, Object &gt; systemProperty : System.getProperties().entrySet() )
                    {
                        propertyNode = junitReport.createElement( TAG_PROPERTY );
                        propertyAttributes = propertyNode.getAttributes();
                        propNameAttr = junitReport.createAttribute( ATTR_PROPERTY_NAME );
                        propNameAttr.setValue( systemProperty.getKey().toString() );
                        propertyAttributes.setNamedItem( propNameAttr );
                        propValueAttr = junitReport.createAttribute( ATTR_PROPERTY_VALUE );
                        propValueAttr.setValue( systemProperty.getValue().toString() );
                        propertyAttributes.setNamedItem( propValueAttr );
                        propertiesNode.appendChild( propertyNode );
                    }
                    Map&lt; String, String &gt; deviceProperties = device.getProperties();
                    for ( Map.Entry&lt; String, String &gt; deviceProperty : deviceProperties.entrySet() )
                    {
                        propertyNode = junitReport.createElement( TAG_PROPERTY );
                        propertyAttributes = propertyNode.getAttributes();
                        propNameAttr = junitReport.createAttribute( ATTR_PROPERTY_NAME );
                        propNameAttr.setValue( deviceProperty.getKey() );
                        propertyAttributes.setNamedItem( propNameAttr );
                        propValueAttr = junitReport.createAttribute( ATTR_PROPERTY_VALUE );
                        propValueAttr.setValue( deviceProperty.getValue() );
                        propertyAttributes.setNamedItem( propValueAttr );
                        propertiesNode.appendChild( propertyNode );
                    }
                    testSuiteNode.appendChild( propertiesNode );
                    testSuitesNode.appendChild( testSuiteNode );
                }
                catch ( ParserConfigurationException e )
                {
                    threwException = true;
                    exceptionMessages.append( &quot;Failed to create document&quot; );
                    exceptionMessages.append( e.getMessage() );
                }
            }
        }

        @Override
        public void testStarted( TestIdentifier testIdentifier )
        {
            testRunCount++;
            getLog().info(
                    deviceLogLinePrefix
                            + String.format( &quot;%1$s%1$sStart [%2$d/%3$d]: %4$s&quot;, INDENT, testRunCount, testCount,
                                    testIdentifier.toString() ) );

            if ( parsedCreateReport )
            { // reset start time for each test run
                currentTestCaseStartTime = new Date().getTime();
                currentTestCaseNode = junitReport.createElement( TAG_TESTCASE );
                NamedNodeMap testCaseAttributes = currentTestCaseNode.getAttributes();
                Attr classAttr = junitReport.createAttribute( ATTR_TESTCASE_CLASSNAME );
                classAttr.setValue( testIdentifier.getClassName() );
                testCaseAttributes.setNamedItem( classAttr );
                Attr methodAttr = junitReport.createAttribute( ATTR_TESTCASE_NAME );
                methodAttr.setValue( testIdentifier.getTestName() );
                testCaseAttributes.setNamedItem( methodAttr );
            }
        }

        @Override
        public void testFailed( TestFailure status, TestIdentifier testIdentifier, String trace )
        {
            if ( status == ERROR )
            {
                ++testErrorCount;
            }
            else
            {
                ++testFailureCount;
            }
            getLog().info( deviceLogLinePrefix + INDENT + INDENT + status.name() + &quot;:&quot; + testIdentifier.toString() );
            getLog().info( deviceLogLinePrefix + INDENT + INDENT + trace );

            if ( parsedCreateReport )
            {
                Node errorFailureNode;
                NamedNodeMap errorfailureAttributes;
                if ( status == ERROR )
                {
                    errorFailureNode = junitReport.createElement( TAG_ERROR );
                    errorfailureAttributes = errorFailureNode.getAttributes();
                }
                else
                {
                    errorFailureNode = junitReport.createElement( TAG_FAILURE );
                    errorfailureAttributes = errorFailureNode.getAttributes();
                }
                errorFailureNode.setTextContent( trace );
                Attr msgAttr = junitReport.createAttribute( ATTR_MESSAGE );
                msgAttr.setValue( parseForMessage( trace ) );
                errorfailureAttributes.setNamedItem( msgAttr );
                Attr typeAttr = junitReport.createAttribute( ATTR_TYPE );
                typeAttr.setValue( parseForException( trace ) );
                errorfailureAttributes.setNamedItem( typeAttr );
                currentTestCaseNode.appendChild( errorFailureNode );
            }
        }

        private void executeOnAdbShell( String command )
        {
            try
            {
                device.executeShellCommand( command, new IShellOutputReceiver()
                {
                    @Override
                    public boolean isCancelled()
                    {
                        return false;
                    }

                    @Override
                    public void flush()
                    {
                    }

                    @Override
                    public void addOutput( byte[] data, int offset, int length )
                    {
                    }
                } );
            }
            catch ( TimeoutException e )
            {
                getLog().error( e );
            }
            catch ( AdbCommandRejectedException e )
            {
                getLog().error( e );
            }
            catch ( ShellCommandUnresponsiveException e )
            {
                getLog().error( e );
            }
            catch ( IOException e )
            {
                getLog().error( e );
            }
        }

        @Override
        public void testEnded( TestIdentifier testIdentifier, Map&lt; String, String &gt; testMetrics )
        {
            getLog().info(
                    deviceLogLinePrefix
                            + String.format( &quot;%1$s%1$sEnd [%2$d/%3$d]: %4$s&quot;, INDENT, testRunCount, testCount,
                                    testIdentifier.toString() ) );
            logMetrics( testMetrics );

            if ( parsedCreateReport )
            {
                testSuiteNode.appendChild( currentTestCaseNode );
                NamedNodeMap testCaseAttributes = currentTestCaseNode.getAttributes();
                Attr timeAttr = junitReport.createAttribute( ATTR_TESTCASE_TIME );
                long now = new Date().getTime();
                double seconds = ( now - currentTestCaseStartTime ) / 1000.0;
                timeAttr.setValue( timeFormatter.format( seconds ) );
                testCaseAttributes.setNamedItem( timeAttr );
            }
        }

        @Override
        public void testRunEnded( long elapsedTime, Map&lt; String, String &gt; runMetrics )
        {
            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run ended: &quot; + elapsedTime + &quot; ms&quot; );
            if ( hasFailuresOrErrors() )
            {
                getLog().error( deviceLogLinePrefix + INDENT + &quot;FAILURES!!!&quot; );
            }
            getLog().info(
                    INDENT + &quot;Tests run: &quot; + testRunCount
                            + ( testRunCount &lt; testCount ? &quot; (of &quot; + testCount + &quot;)&quot; : &quot;&quot; ) + &quot;,  Failures: &quot;
                            + testFailureCount + &quot;,  Errors: &quot; + testErrorCount );

            if ( parsedCreateReport )
            {
                NamedNodeMap testSuiteAttributes = testSuiteNode.getAttributes();
                Attr testCountAttr = junitReport.createAttribute( ATTR_TESTSUITE_TESTS );
                testCountAttr.setValue( Integer.toString( testCount ) );
                testSuiteAttributes.setNamedItem( testCountAttr );
                Attr testFailuresAttr = junitReport.createAttribute( ATTR_TESTSUITE_FAILURES );
                testFailuresAttr.setValue( Integer.toString( testFailureCount ) );
                testSuiteAttributes.setNamedItem( testFailuresAttr );
                Attr testErrorsAttr = junitReport.createAttribute( ATTR_TESTSUITE_ERRORS );
                testErrorsAttr.setValue( Integer.toString( testErrorCount ) );
                testSuiteAttributes.setNamedItem( testErrorsAttr );
                Attr timeAttr = junitReport.createAttribute( ATTR_TESTSUITE_TIME );
                timeAttr.setValue( timeFormatter.format( elapsedTime / 1000.0 ) );
                testSuiteAttributes.setNamedItem( timeAttr );
                Attr timeStampAttr = junitReport.createAttribute( ATTR_TESTSUITE_TIMESTAMP );
                timeStampAttr.setValue( new Date().toString() );
                testSuiteAttributes.setNamedItem( timeStampAttr );
            }

            logMetrics( runMetrics );

            if ( parsedCreateReport )
            {
                writeJunitReportToFile();
            }
        }

        @Override
        public void testRunFailed( String errorMessage )
        {
            testRunFailureCause = errorMessage;
            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run failed: &quot; + errorMessage );
        }

        @Override
        public void testRunStopped( long elapsedTime )
        {
            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run stopped:&quot; + elapsedTime );
        }

        /**
         * Parse a trace string for the message in it. Assumes that the message is located after &quot;:&quot; and before &quot;\r\n&quot;.
         * 
         * @param trace
         * @return message or empty string
         */
        private String parseForMessage( String trace )
        {
            if ( StringUtils.isNotBlank( trace ) )
            {
                String newline = &quot;\r\n&quot;;
                // if there is message like
                // junit.junit.framework.AssertionFailedError ... there is no
                // message
                int messageEnd = trace.indexOf( newline );
                boolean hasMessage = !trace.startsWith( &quot;junit.&quot; ) &amp;&amp; messageEnd &gt; 0;
                if ( hasMessage )
                {
                    int messageStart = trace.indexOf( &quot;:&quot; ) + 2;
                    if ( messageStart &gt; messageEnd )
                    {
                        messageEnd = trace.indexOf( newline + &quot;at&quot; );
                        // match start of stack trace &quot;\r\nat org.junit.....&quot;
                        if ( messageStart &gt; messageEnd )
                        {
                            // ':' wasn't found in message but in stack trace
                            messageStart = 0;
                        }
                    }
                    return trace.substring( messageStart, messageEnd );
                }
                else
                {
                    return StringUtils.EMPTY;
                }
            }
            else
            {
                return StringUtils.EMPTY;
            }
        }

        /**
         * Parse a trace string for the exception class. Assumes that it is the start of the trace and ends at the first
         * &quot;:&quot;.
         * 
         * @param trace
         * @return Exception class as string or empty string
         */
        private String parseForException( String trace )
        {
            if ( StringUtils.isNotBlank( trace ) )
            {
                return trace.substring( 0, trace.indexOf( &quot;:&quot; ) );
            }
            else
            {
                return StringUtils.EMPTY;
            }
        }

        /**
         * Write the junit report xml file.
         */
        private void writeJunitReportToFile()
        {
            TransformerFactory xfactory = TransformerFactory.newInstance();
            Transformer xformer = null;
            try
            {
                xformer = xfactory.newTransformer();
            }
            catch ( TransformerConfigurationException e )
            {
                e.printStackTrace();
            }
            Source source = new DOMSource( junitReport );

            FileWriter writer = null;
            try
            {
                String directory = new StringBuilder().append( project.getBuild().getDirectory() )
                        .append( &quot;/surefire-reports&quot; ).toString();

                FileUtils.forceMkdir( new File( directory ) );

                String fileName = new StringBuilder().append( directory ).append( &quot;/TEST-&quot; )
                        .append( DeviceHelper.getDescriptiveName( device ) ).append( &quot;.xml&quot; ).toString();
                File reportFile = new File( fileName );
                writer = new FileWriter( reportFile );
                Result result = new StreamResult( writer );

                xformer.transform( source, result );
                getLog().info( deviceLogLinePrefix + &quot;Report file written to &quot; + reportFile.getAbsolutePath() );
            }
            catch ( IOException e )
            {
                threwException = true;
                exceptionMessages.append( &quot;Failed to write test report file&quot; );
                exceptionMessages.append( e.getMessage() );
            }
            catch ( TransformerException e )
            {
                threwException = true;
                exceptionMessages.append( &quot;Failed to transform document to write to test report file&quot; );
                exceptionMessages.append( e.getMessage() );
            }
            finally
            {
                IOUtils.closeQuietly( writer );
            }
        }

        /**
         * Log all the metrics out in to key: value lines.
         * 
         * @param metrics
         */
        private void logMetrics( Map&lt; String, String &gt; metrics )
        {
            for ( Map.Entry&lt; String, String &gt; entry : metrics.entrySet() )
            {
                getLog().info( deviceLogLinePrefix + INDENT + INDENT + entry.getKey() + &quot;: &quot; + entry.getValue() );
            }
        }

        /**
         * @return if any failures or errors occurred in the test run.
         */
        public boolean hasFailuresOrErrors()
        {
            return testErrorCount &gt; 0 || testFailureCount &gt; 0;
        }

        /**
         * @return if the test run itself failed - a failure in the test infrastructure, not a test failure.
         */
        public boolean testRunFailed()
        {
            return testRunFailureCause != null;
        }

        /**
         * @return the cause of test failure if any.
         */
        public String getTestRunFailureCause()
        {
            return testRunFailureCause;
        }

        /**
         * @return if any exception was thrown during the test run on the build system (not the Android device or
         *         emulator)
         */
        public boolean threwException()
        {
            return threwException;
        }

        /**
         * @return all exception messages thrown during test execution on the test run time (not the Android device or
         *         emulator)
         */
        public String getExceptionMessages()
        {
            return exceptionMessages.toString();
        }
    }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L758">758</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L696">696</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L668">668</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>            if ( status == ERROR )
            {
                ++testErrorCount;
            }
            else
            {
                ++testFailureCount;
            }
            getLog().info( deviceLogLinePrefix + INDENT + INDENT + status.name() + &quot;:&quot; + testIdentifier.toString() );
            getLog().info( deviceLogLinePrefix + INDENT + INDENT + trace );

            if ( parsedCreateReport )
            {
                Node errorFailureNode;
                NamedNodeMap errorfailureAttributes;
                if ( status == ERROR )
                {
                    errorFailureNode = junitReport.createElement( TAG_ERROR );
                    errorfailureAttributes = errorFailureNode.getAttributes();
                }
                else
                {
                    errorFailureNode = junitReport.createElement( TAG_FAILURE );
                    errorfailureAttributes = errorFailureNode.getAttributes();
                }
                errorFailureNode.setTextContent( trace );
                Attr msgAttr = junitReport.createAttribute( ATTR_MESSAGE );
                msgAttr.setValue( parseForMessage( trace ) );
                errorfailureAttributes.setNamedItem( msgAttr );
                Attr typeAttr = junitReport.createAttribute( ATTR_TYPE );
                typeAttr.setValue( parseForException( trace ) );
                errorfailureAttributes.setNamedItem( typeAttr );
                currentTestCaseNode.appendChild( errorFailureNode );
            }
        }

        private void executeOnAdbShell( String command )
        {
            try
            {
                device.executeShellCommand( command, new IShellOutputReceiver()
                {
                    @Override
                    public boolean isCancelled()
                    {
                        return false;
                    }

                    @Override
                    public void flush()
                    {
                    }

                    @Override
                    public void addOutput( byte[] data, int offset, int length )
                    {
                    }
                } );
            }
            catch ( TimeoutException e )
            {
                getLog().error( e );
            }
            catch ( AdbCommandRejectedException e )
            {
                getLog().error( e );
            }
            catch ( ShellCommandUnresponsiveException e )
            {
                getLog().error( e );
            }
            catch ( IOException e )
            {
                getLog().error( e );
            }
        }

        @Override
        public void testEnded( TestIdentifier testIdentifier, Map&lt; String, String &gt; testMetrics )
        {
            getLog().info(
                    deviceLogLinePrefix
                            + String.format( &quot;%1$s%1$sEnd [%2$d/%3$d]: %4$s&quot;, INDENT, testRunCount, testCount,
                                    testIdentifier.toString() ) );
            logMetrics( testMetrics );

            if ( parsedCreateReport )
            {
                testSuiteNode.appendChild( currentTestCaseNode );
                NamedNodeMap testCaseAttributes = currentTestCaseNode.getAttributes();
                Attr timeAttr = junitReport.createAttribute( ATTR_TESTCASE_TIME );
                long now = new Date().getTime();
                double seconds = ( now - currentTestCaseStartTime ) / 1000.0;
                timeAttr.setValue( timeFormatter.format( seconds ) );
                testCaseAttributes.setNamedItem( timeAttr );
            }
        }

        @Override
        public void testRunEnded( long elapsedTime, Map&lt; String, String &gt; runMetrics )
        {
            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run ended: &quot; + elapsedTime + &quot; ms&quot; );
            if ( hasFailuresOrErrors() )
            {
                getLog().error( deviceLogLinePrefix + INDENT + &quot;FAILURES!!!&quot; );
            }
            getLog().info(
                    INDENT + &quot;Tests run: &quot; + testRunCount
                            + ( testRunCount &lt; testCount ? &quot; (of &quot; + testCount + &quot;)&quot; : &quot;&quot; ) + &quot;,  Failures: &quot;
                            + testFailureCount + &quot;,  Errors: &quot; + testErrorCount );

            if ( parsedCreateReport )
            {
                NamedNodeMap testSuiteAttributes = testSuiteNode.getAttributes();
                Attr testCountAttr = junitReport.createAttribute( ATTR_TESTSUITE_TESTS );
                testCountAttr.setValue( Integer.toString( testCount ) );
                testSuiteAttributes.setNamedItem( testCountAttr );
                Attr testFailuresAttr = junitReport.createAttribute( ATTR_TESTSUITE_FAILURES );
                testFailuresAttr.setValue( Integer.toString( testFailureCount ) );
                testSuiteAttributes.setNamedItem( testFailuresAttr );
                Attr testErrorsAttr = junitReport.createAttribute( ATTR_TESTSUITE_ERRORS );
                testErrorsAttr.setValue( Integer.toString( testErrorCount ) );
                testSuiteAttributes.setNamedItem( testErrorsAttr );
                Attr timeAttr = junitReport.createAttribute( ATTR_TESTSUITE_TIME );
                timeAttr.setValue( timeFormatter.format( elapsedTime / 1000.0 ) );
                testSuiteAttributes.setNamedItem( timeAttr );
                Attr timeStampAttr = junitReport.createAttribute( ATTR_TESTSUITE_TIMESTAMP );
                timeStampAttr.setValue( new Date().toString() );
                testSuiteAttributes.setNamedItem( timeStampAttr );
            }

            logMetrics( runMetrics );

            if ( parsedCreateReport )
            {
                writeJunitReportToFile();
            }
        }

        @Override
        public void testRunFailed( String errorMessage )
        {
            testRunFailureCause = errorMessage;
            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run failed: &quot; + errorMessage );
        }

        @Override
        public void testRunStopped( long elapsedTime )
        {
            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run stopped:&quot; + elapsedTime );
        }

        /**
         * Parse a trace string for the message in it. Assumes that the message is located after &quot;:&quot; and before &quot;\r\n&quot;.
         * 
         * @param trace
         * @return message or empty string
         */
        private String parseForMessage( String trace )
        {
            if ( StringUtils.isNotBlank( trace ) )
            {
                String newline = &quot;\r\n&quot;;
                // if there is message like
                // junit.junit.framework.AssertionFailedError ... there is no
                // message
                int messageEnd = trace.indexOf( newline );
                boolean hasMessage = !trace.startsWith( &quot;junit.&quot; ) &amp;&amp; messageEnd &gt; 0;
                if ( hasMessage )
                {
                    int messageStart = trace.indexOf( &quot;:&quot; ) + 2;
                    if ( messageStart &gt; messageEnd )
                    {
                        messageEnd = trace.indexOf( newline + &quot;at&quot; );
                        // match start of stack trace &quot;\r\nat org.junit.....&quot;
                        if ( messageStart &gt; messageEnd )
                        {
                            // ':' wasn't found in message but in stack trace
                            messageStart = 0;
                        }
                    }
                    return trace.substring( messageStart, messageEnd );
                }
                else
                {
                    return StringUtils.EMPTY;
                }
            }
            else
            {
                return StringUtils.EMPTY;
            }
        }

        /**
         * Parse a trace string for the exception class. Assumes that it is the start of the trace and ends at the first
         * &quot;:&quot;.
         * 
         * @param trace
         * @return Exception class as string or empty string
         */
        private String parseForException( String trace )
        {
            if ( StringUtils.isNotBlank( trace ) )
            {
                return trace.substring( 0, trace.indexOf( &quot;:&quot; ) );
            }
            else
            {
                return StringUtils.EMPTY;
            }
        }

        /**
         * Write the junit report xml file.
         */
        private void writeJunitReportToFile()
        {
            TransformerFactory xfactory = TransformerFactory.newInstance();
            Transformer xformer = null;
            try
            {
                xformer = xfactory.newTransformer();
            }
            catch ( TransformerConfigurationException e )
            {
                e.printStackTrace();
            }
            Source source = new DOMSource( junitReport );

            FileWriter writer = null;
            try
            {
                String directory = new StringBuilder().append( project.getBuild().getDirectory() )
                        .append( &quot;/surefire-reports&quot; ).toString();

                FileUtils.forceMkdir( new File( directory ) );</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L669">669</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L607">607</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L570">570</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            this.testCount = tCount;
            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run started: &quot; + runName + &quot;, &quot; + testCount + &quot; tests:&quot; );

            if ( parsedCreateReport )
            {
                try
                {
                    DocumentBuilderFactory fact = DocumentBuilderFactory.newInstance();
                    DocumentBuilder parser = null;
                    parser = fact.newDocumentBuilder();
                    junitReport = parser.newDocument();
                    Node testSuitesNode = junitReport.createElement( TAG_TESTSUITES );
                    junitReport.appendChild( testSuitesNode );
                    testSuiteNode = junitReport.createElement( TAG_TESTSUITE );
                    NamedNodeMap testSuiteAttributes = testSuiteNode.getAttributes();
                    Attr nameAttr = junitReport.createAttribute( ATTR_TESTSUITE_NAME );
                    nameAttr.setValue( runName );
                    testSuiteAttributes.setNamedItem( nameAttr );
                    Attr hostnameAttr = junitReport.createAttribute( ATTR_TESTSUITE_HOSTNAME );
                    hostnameAttr.setValue( DeviceHelper.getDescriptiveName( device ) );
                    testSuiteAttributes.setNamedItem( hostnameAttr );
                    Node propertiesNode = junitReport.createElement( TAG_PROPERTIES );
                    Node propertyNode;
                    NamedNodeMap propertyAttributes;
                    Attr propNameAttr;
                    Attr propValueAttr;
                    for ( Map.Entry&lt; Object, Object &gt; systemProperty : System.getProperties().entrySet() )
                    {
                        propertyNode = junitReport.createElement( TAG_PROPERTY );
                        propertyAttributes = propertyNode.getAttributes();
                        propNameAttr = junitReport.createAttribute( ATTR_PROPERTY_NAME );
                        propNameAttr.setValue( systemProperty.getKey().toString() );
                        propertyAttributes.setNamedItem( propNameAttr );
                        propValueAttr = junitReport.createAttribute( ATTR_PROPERTY_VALUE );
                        propValueAttr.setValue( systemProperty.getValue().toString() );
                        propertyAttributes.setNamedItem( propValueAttr );
                        propertiesNode.appendChild( propertyNode );
                    }
                    Map&lt; String, String &gt; deviceProperties = device.getProperties();
                    for ( Map.Entry&lt; String, String &gt; deviceProperty : deviceProperties.entrySet() )
                    {
                        propertyNode = junitReport.createElement( TAG_PROPERTY );
                        propertyAttributes = propertyNode.getAttributes();
                        propNameAttr = junitReport.createAttribute( ATTR_PROPERTY_NAME );
                        propNameAttr.setValue( deviceProperty.getKey() );
                        propertyAttributes.setNamedItem( propNameAttr );
                        propValueAttr = junitReport.createAttribute( ATTR_PROPERTY_VALUE );
                        propValueAttr.setValue( deviceProperty.getValue() );
                        propertyAttributes.setNamedItem( propValueAttr );
                        propertiesNode.appendChild( propertyNode );
                    }
                    testSuiteNode.appendChild( propertiesNode );
                    testSuitesNode.appendChild( testSuiteNode );
                }
                catch ( ParserConfigurationException e )
                {
                    threwException = true;
                    exceptionMessages.append( &quot;Failed to create document&quot; );
                    exceptionMessages.append( e.getMessage() );
                }
            }
        }

        @Override
        public void testStarted( TestIdentifier testIdentifier )
        {
            testRunCount++;
            getLog().info(
                    deviceLogLinePrefix
                            + String.format( &quot;%1$s%1$sStart [%2$d/%3$d]: %4$s&quot;, INDENT, testRunCount, testCount,
                                    testIdentifier.toString() ) );

            if ( parsedCreateReport )
            { // reset start time for each test run
                currentTestCaseStartTime = new Date().getTime();
                currentTestCaseNode = junitReport.createElement( TAG_TESTCASE );
                NamedNodeMap testCaseAttributes = currentTestCaseNode.getAttributes();
                Attr classAttr = junitReport.createAttribute( ATTR_TESTCASE_CLASSNAME );
                classAttr.setValue( testIdentifier.getClassName() );
                testCaseAttributes.setNamedItem( classAttr );
                Attr methodAttr = junitReport.createAttribute( ATTR_TESTCASE_NAME );
                methodAttr.setValue( testIdentifier.getTestName() );
                testCaseAttributes.setNamedItem( methodAttr );
            }
        }

        @Override
        public void testFailed( TestFailure status, TestIdentifier testIdentifier, String trace )
        {
            if ( status == ERROR )</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/AbstractInstrumentationMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/AbstractInstrumentationMojo.html#L958">958</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L905">905</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L843">843</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>        public void testRunStopped( long elapsedTime )
        {
            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run stopped:&quot; + elapsedTime );
        }


        /**
         * Parse a trace string for the message in it. Assumes that the message is located after &quot;:&quot; and before
         * &quot;\r\n&quot;.
         *
         * @param trace
         * @return message or empty string
         */
        private String parseForMessage( String trace )
        {
            if ( StringUtils.isNotBlank( trace ) )
            {
                String newline = &quot;\r\n&quot;;
                // if there is message like
                // junit.junit.framework.AssertionFailedError ... there is no message
                int messageEnd = trace.indexOf( newline );
                boolean hasMessage = ! trace.startsWith( &quot;junit.&quot; ) &amp;&amp; messageEnd &gt; 0;
                if ( hasMessage )
                {
                    int messageStart = trace.indexOf( &quot;:&quot; ) + 2;
                    if ( messageStart &gt; messageEnd )
                    {
                        messageEnd = trace.indexOf( newline + &quot;at&quot; );
                        // match start of stack trace &quot;\r\nat org.junit.....&quot;
                        if ( messageStart &gt; messageEnd )
                        {
                            //':' wasn't found in message but in stack trace
                            messageStart = 0;
                        }
                    }
                    return trace.substring( messageStart, messageEnd );
                }
                else
                {
                    return StringUtils.EMPTY;
                }
            }
            else
            {
                return StringUtils.EMPTY;
            }
        }

        /**
         * Parse a trace string for the exception class. Assumes that it is the start of the trace and ends at the first
         * &quot;:&quot;.
         *
         * @param trace
         * @return Exception class as string or empty string
         */
        private String parseForException( String trace )
        {
            if ( StringUtils.isNotBlank( trace ) )
            {
                return trace.substring( 0, trace.indexOf( &quot;:&quot; ) );
            }
            else
            {
                return StringUtils.EMPTY;
            }
        }

        /**
         * Write the junit report xml file.
         */
        private void writeJunitReportToFile()
        {
            TransformerFactory xfactory = TransformerFactory.newInstance();
            Transformer xformer = null;
            try
            {
                xformer = xfactory.newTransformer();
            }
            catch ( TransformerConfigurationException e )
            {
                e.printStackTrace();
            }
            Source source = new DOMSource( junitReport );

            FileWriter writer = null;
            try
            {
                String directory = new StringBuilder().append( project.getBuild().getDirectory() )
                        .append( &quot;/surefire-reports&quot; ).toString();

                FileUtils.forceMkdir( new File( directory ) );

                String fileName = new StringBuilder().append( directory ).append( &quot;/TEST-&quot; )
                        .append( DeviceHelper.getDescriptiveName( device ) ).append( &quot;.xml&quot; ).toString();
                File reportFile = new File( fileName );
                writer = new FileWriter( reportFile );
                Result result = new StreamResult( writer );

                xformer.transform( source, result );
                getLog().info( deviceLogLinePrefix + &quot;Report file written to &quot; + reportFile.getAbsolutePath() );
            }
            catch ( IOException e )
            {
                threwException = true;
                exceptionMessages.append( &quot;Failed to write test report file&quot; );
                exceptionMessages.append( e.getMessage() );
            }
            catch ( TransformerException e )
            {
                threwException = true;
                exceptionMessages.append( &quot;Failed to transform document to write to test report file&quot; );
                exceptionMessages.append( e.getMessage() );
            }
            finally
            {
                IOUtils.closeQuietly( writer );
            }
        }

        /**
         * Log all the metrics out in to key: value lines.
         *
         * @param metrics
         */
        private void logMetrics( Map&lt;String, String&gt; metrics )
        {
            for ( Map.Entry&lt;String, String&gt; entry : metrics.entrySet() )
            {
                getLog().info( deviceLogLinePrefix + INDENT + INDENT + entry.getKey() + &quot;: &quot; + entry.getValue() );
            }
        }

        /**
         * @return if any failures or errors occurred in the test run.
         */
        public boolean hasFailuresOrErrors()
        {</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/AbstractInstrumentationMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/AbstractInstrumentationMojo.html#L744">744</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L670">670</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L608">608</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L571">571</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run started: &quot; + runName + &quot;, &quot; + testCount + &quot; tests:&quot; );

            if ( parsedCreateReport )
            {
                try
                {
                    DocumentBuilderFactory fact = DocumentBuilderFactory.newInstance();
                    DocumentBuilder parser = null;
                    parser = fact.newDocumentBuilder();
                    junitReport = parser.newDocument();

                    Node testSuitesNode = junitReport.createElement( TAG_TESTSUITES );
                    junitReport.appendChild( testSuitesNode );

                    testSuiteNode = junitReport.createElement( TAG_TESTSUITE );
                    NamedNodeMap testSuiteAttributes = testSuiteNode.getAttributes();

                    Attr nameAttr = junitReport.createAttribute( ATTR_TESTSUITE_NAME );
                    nameAttr.setValue( runName );
                    testSuiteAttributes.setNamedItem( nameAttr );

                    Attr hostnameAttr = junitReport.createAttribute( ATTR_TESTSUITE_HOSTNAME );
                    hostnameAttr.setValue( DeviceHelper.getDescriptiveName( device ) );
                    testSuiteAttributes.setNamedItem( hostnameAttr );

                    Node propertiesNode = junitReport.createElement( TAG_PROPERTIES );
                    Node propertyNode;
                    NamedNodeMap propertyAttributes;
                    Attr propNameAttr;
                    Attr propValueAttr;
                    for ( Map.Entry&lt;Object, Object&gt; systemProperty : System.getProperties().entrySet() )
                    {
                        propertyNode = junitReport.createElement( TAG_PROPERTY );
                        propertyAttributes = propertyNode.getAttributes();

                        propNameAttr = junitReport.createAttribute( ATTR_PROPERTY_NAME );
                        propNameAttr.setValue( systemProperty.getKey().toString() );
                        propertyAttributes.setNamedItem( propNameAttr );

                        propValueAttr = junitReport.createAttribute( ATTR_PROPERTY_VALUE );
                        propValueAttr.setValue( systemProperty.getValue().toString() );
                        propertyAttributes.setNamedItem( propValueAttr );

                        propertiesNode.appendChild( propertyNode );

                    }
                    Map&lt;String, String&gt; deviceProperties = device.getProperties();
                    for ( Map.Entry&lt;String, String&gt; deviceProperty : deviceProperties.entrySet() )
                    {
                        propertyNode = junitReport.createElement( TAG_PROPERTY );
                        propertyAttributes = propertyNode.getAttributes();

                        propNameAttr = junitReport.createAttribute( ATTR_PROPERTY_NAME );
                        propNameAttr.setValue( deviceProperty.getKey() );
                        propertyAttributes.setNamedItem( propNameAttr );

                        propValueAttr = junitReport.createAttribute( ATTR_PROPERTY_VALUE );
                        propValueAttr.setValue( deviceProperty.getValue() );
                        propertyAttributes.setNamedItem( propValueAttr );

                        propertiesNode.appendChild( propertyNode );
                    }

                    testSuiteNode.appendChild( propertiesNode );

                    testSuitesNode.appendChild( testSuiteNode );

                }
                catch ( ParserConfigurationException e )
                {
                    threwException = true;
                    exceptionMessages.append( &quot;Failed to create document&quot; );
                    exceptionMessages.append( e.getMessage() );
                }
            }
        }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L562">562</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L458">458</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>        doWithDevices( instrumentationTestExecutor );
    }

    /**
     * AndroidTestRunListener produces a nice output for the log for the test run as well as an xml file compatible with
     * the junit xml report file format understood by many tools.
     * &lt;p/&gt;
     * It will do so for each device/emulator the tests run on.
     */
    public class AndroidTestRunListener implements ITestRunListener
    {
        private static final String SCREENSHOT_SUFFIX = &quot;_screenshot.png&quot;;

        /**
         * the indent used in the log to group items that belong together visually *
         */
        private static final String INDENT = &quot;  &quot;;

        /**
         * Junit report schema documentation is sparse. Here are some hints
         * 
         * @see &quot;http://mail-archives.apache.org/mod_mbox/ ant-dev/200902.mbox/%3
         *      Cdffc72020902241548l4316d645w2e98caf5f0aac770
         * @mail.gmail.com%3E&quot;
         * @see &quot;http://junitpdfreport.sourceforge.net/managedcontent/PdfTranslation&quot;
         */
        private static final String TAG_TESTSUITES = &quot;testsuites&quot;;

        private static final String TAG_TESTSUITE = &quot;testsuite&quot;;
        private static final String ATTR_TESTSUITE_ERRORS = &quot;errors&quot;;
        private static final String ATTR_TESTSUITE_FAILURES = &quot;failures&quot;;
        private static final String ATTR_TESTSUITE_HOSTNAME = &quot;hostname&quot;;
        private static final String ATTR_TESTSUITE_NAME = &quot;name&quot;;
        private static final String ATTR_TESTSUITE_TESTS = &quot;tests&quot;;
        private static final String ATTR_TESTSUITE_TIME = &quot;time&quot;;
        private static final String ATTR_TESTSUITE_TIMESTAMP = &quot;timestamp&quot;;

        private static final String TAG_PROPERTIES = &quot;properties&quot;;
        private static final String TAG_PROPERTY = &quot;property&quot;;
        private static final String ATTR_PROPERTY_NAME = &quot;name&quot;;
        private static final String ATTR_PROPERTY_VALUE = &quot;value&quot;;

        private static final String TAG_TESTCASE = &quot;testcase&quot;;
        private static final String ATTR_TESTCASE_NAME = &quot;name&quot;;
        private static final String ATTR_TESTCASE_CLASSNAME = &quot;classname&quot;;
        private static final String ATTR_TESTCASE_TIME = &quot;time&quot;;

        private static final String TAG_ERROR = &quot;error&quot;;
        private static final String TAG_FAILURE = &quot;failure&quot;;
        private static final String ATTR_MESSAGE = &quot;message&quot;;
        private static final String ATTR_TYPE = &quot;type&quot;;

        /**
         * time format for the output of milliseconds in seconds in the xml file *
         */
        private final NumberFormat timeFormatter = new DecimalFormat( &quot;#0.0000&quot; );

        private int testCount = 0;
        private int testRunCount = 0;
        private int testFailureCount = 0;
        private int testErrorCount = 0;
        private String testRunFailureCause = null;

        private final MavenProject project;
        /**
         * the emulator or device we are running the tests on *
         */
        private final IDevice device;

        private final String deviceLogLinePrefix;

        // junit xml report related fields
        private Document junitReport;
        private Node testSuiteNode;

        /**
         * node for the current test case for junit report
         */
        private Node currentTestCaseNode;
        /**
         * start time of current test case in millis, reset with each test start
         */
        private long currentTestCaseStartTime;

        // we track if we have problems and then report upstream
        private boolean threwException = false;
        private final StringBuilder exceptionMessages = new StringBuilder();

        /**
         * Create a new test run listener.
         * 
         * @param project
         *            the test project.
         * @param device
         *            the device on which test is executed.
         */
        public AndroidTestRunListener( MavenProject project, IDevice device )
        {
            this.project = project;
            this.device = device;
            this.deviceLogLinePrefix = DeviceHelper.getDeviceLogLinePrefix( device );
        }

        @Override
        public void testRunStarted( String runName, int tCount )
        {</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L501">501</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L459">459</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>    }

    /**
     * AndroidTestRunListener produces a nice output for the log for the test run as well as an xml file compatible with
     * the junit xml report file format understood by many tools.
     * &lt;p/&gt;
     * It will do so for each device/emulator the tests run on.
     */
    public class AndroidTestRunListener implements ITestRunListener
    {
        private static final String SCREENSHOT_SUFFIX = &quot;_screenshot.png&quot;;

        /**
         * the indent used in the log to group items that belong together visually *
         */
        private static final String INDENT = &quot;  &quot;;

        /**
         * Junit report schema documentation is sparse. Here are some hints
         * 
         * @see &quot;http://mail-archives.apache.org/mod_mbox/ ant-dev/200902.mbox/%3
         *      Cdffc72020902241548l4316d645w2e98caf5f0aac770
         * @mail.gmail.com%3E&quot;
         * @see &quot;http://junitpdfreport.sourceforge.net/managedcontent/PdfTranslation&quot;
         */
        private static final String TAG_TESTSUITES = &quot;testsuites&quot;;

        private static final String TAG_TESTSUITE = &quot;testsuite&quot;;
        private static final String ATTR_TESTSUITE_ERRORS = &quot;errors&quot;;
        private static final String ATTR_TESTSUITE_FAILURES = &quot;failures&quot;;
        private static final String ATTR_TESTSUITE_HOSTNAME = &quot;hostname&quot;;
        private static final String ATTR_TESTSUITE_NAME = &quot;name&quot;;
        private static final String ATTR_TESTSUITE_TESTS = &quot;tests&quot;;
        private static final String ATTR_TESTSUITE_TIME = &quot;time&quot;;
        private static final String ATTR_TESTSUITE_TIMESTAMP = &quot;timestamp&quot;;

        private static final String TAG_PROPERTIES = &quot;properties&quot;;
        private static final String TAG_PROPERTY = &quot;property&quot;;
        private static final String ATTR_PROPERTY_NAME = &quot;name&quot;;
        private static final String ATTR_PROPERTY_VALUE = &quot;value&quot;;

        private static final String TAG_TESTCASE = &quot;testcase&quot;;
        private static final String ATTR_TESTCASE_NAME = &quot;name&quot;;
        private static final String ATTR_TESTCASE_CLASSNAME = &quot;classname&quot;;
        private static final String ATTR_TESTCASE_TIME = &quot;time&quot;;

        private static final String TAG_ERROR = &quot;error&quot;;
        private static final String TAG_FAILURE = &quot;failure&quot;;
        private static final String ATTR_MESSAGE = &quot;message&quot;;
        private static final String ATTR_TYPE = &quot;type&quot;;

        /**
         * time format for the output of milliseconds in seconds in the xml file *
         */
        private final NumberFormat timeFormatter = new DecimalFormat( &quot;#0.0000&quot; );

        private int testCount = 0;
        private int testRunCount = 0;
        private int testFailureCount = 0;
        private int testErrorCount = 0;
        private String testRunFailureCause = null;

        private final MavenProject project;
        /**
         * the emulator or device we are running the tests on *
         */
        private final IDevice device;

        private final String deviceLogLinePrefix;

        // junit xml report related fields
        private Document junitReport;
        private Node testSuiteNode;

        /**
         * node for the current test case for junit report
         */
        private Node currentTestCaseNode;
        /**
         * start time of current test case in millis, reset with each test start
         */
        private long currentTestCaseStartTime;

        // we track if we have problems and then report upstream
        private boolean threwException = false;
        private final StringBuilder exceptionMessages = new StringBuilder();

        /**
         * Create a new test run listener.
         * 
         * @param project
         *            the test project.
         * @param device
         *            the device on which test is executed.
         */
        public AndroidTestRunListener( MavenProject project, IDevice device )
        {
            this.project = project;
            this.device = device;
            this.deviceLogLinePrefix = DeviceHelper.getDeviceLogLinePrefix( device );
        }

        @Override
        public void testRunStarted( String runName, int tCount )
        {</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/AbstractInstrumentationMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/AbstractInstrumentationMojo.html#L958">958</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L815">815</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>        public void testRunStopped( long elapsedTime )
        {
            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run stopped:&quot; + elapsedTime );
        }


        /**
         * Parse a trace string for the message in it. Assumes that the message is located after &quot;:&quot; and before
         * &quot;\r\n&quot;.
         *
         * @param trace
         * @return message or empty string
         */
        private String parseForMessage( String trace )
        {
            if ( StringUtils.isNotBlank( trace ) )
            {
                String newline = &quot;\r\n&quot;;
                // if there is message like
                // junit.junit.framework.AssertionFailedError ... there is no message
                int messageEnd = trace.indexOf( newline );
                boolean hasMessage = ! trace.startsWith( &quot;junit.&quot; ) &amp;&amp; messageEnd &gt; 0;
                if ( hasMessage )
                {
                    int messageStart = trace.indexOf( &quot;:&quot; ) + 2;
                    if ( messageStart &gt; messageEnd )
                    {
                        messageEnd = trace.indexOf( newline + &quot;at&quot; );
                        // match start of stack trace &quot;\r\nat org.junit.....&quot;
                        if ( messageStart &gt; messageEnd )
                        {
                            //':' wasn't found in message but in stack trace
                            messageStart = 0;
                        }
                    }
                    return trace.substring( messageStart, messageEnd );
                }
                else
                {
                    return StringUtils.EMPTY;
                }
            }
            else
            {
                return StringUtils.EMPTY;
            }
        }

        /**
         * Parse a trace string for the exception class. Assumes that it is the start of the trace and ends at the first
         * &quot;:&quot;.
         *
         * @param trace
         * @return Exception class as string or empty string
         */
        private String parseForException( String trace )
        {
            if ( StringUtils.isNotBlank( trace ) )
            {
                return trace.substring( 0, trace.indexOf( &quot;:&quot; ) );
            }
            else
            {
                return StringUtils.EMPTY;
            }
        }

        /**
         * Write the junit report xml file.
         */
        private void writeJunitReportToFile()
        {
            TransformerFactory xfactory = TransformerFactory.newInstance();
            Transformer xformer = null;
            try
            {
                xformer = xfactory.newTransformer();
            }
            catch ( TransformerConfigurationException e )
            {
                e.printStackTrace();
            }
            Source source = new DOMSource( junitReport );

            FileWriter writer = null;
            try
            {
                String directory = new StringBuilder().append( project.getBuild().getDirectory() )
                        .append( &quot;/surefire-reports&quot; ).toString();

                FileUtils.forceMkdir( new File( directory ) );</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/AbstractInstrumentationMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/AbstractInstrumentationMojo.html#L662">662</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L578">578</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L516">516</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L474">474</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>        private static final String INDENT = &quot;  &quot;;

        /**
         * Junit report schema documentation is sparse. Here are some hints
         *
         * @see &quot;http://mail-archives.apache.org/mod_mbox/
         *      ant-dev/200902.mbox/%3Cdffc72020902241548l4316d645w2e98caf5f0aac770@mail.gmail.com%3E&quot;
         * @see &quot;http://junitpdfreport.sourceforge.net/managedcontent/PdfTranslation&quot;
         */
        private static final String TAG_TESTSUITES = &quot;testsuites&quot;;

        private static final String TAG_TESTSUITE = &quot;testsuite&quot;;
        private static final String ATTR_TESTSUITE_ERRORS = &quot;errors&quot;;
        private static final String ATTR_TESTSUITE_FAILURES = &quot;failures&quot;;
        private static final String ATTR_TESTSUITE_HOSTNAME = &quot;hostname&quot;;
        private static final String ATTR_TESTSUITE_NAME = &quot;name&quot;;
        private static final String ATTR_TESTSUITE_TESTS = &quot;tests&quot;;
        private static final String ATTR_TESTSUITE_TIME = &quot;time&quot;;
        private static final String ATTR_TESTSUITE_TIMESTAMP = &quot;timestamp&quot;;

        private static final String TAG_PROPERTIES = &quot;properties&quot;;
        private static final String TAG_PROPERTY = &quot;property&quot;;
        private static final String ATTR_PROPERTY_NAME = &quot;name&quot;;
        private static final String ATTR_PROPERTY_VALUE = &quot;value&quot;;

        private static final String TAG_TESTCASE = &quot;testcase&quot;;
        private static final String ATTR_TESTCASE_NAME = &quot;name&quot;;
        private static final String ATTR_TESTCASE_CLASSNAME = &quot;classname&quot;;
        private static final String ATTR_TESTCASE_TIME = &quot;time&quot;;

        private static final String TAG_ERROR = &quot;error&quot;;
        private static final String TAG_FAILURE = &quot;failure&quot;;
        private static final String ATTR_MESSAGE = &quot;message&quot;;
        private static final String ATTR_TYPE = &quot;type&quot;;


        /**
         * time format for the output of milliseconds in seconds in the xml file *
         */
        private final NumberFormat timeFormatter = new DecimalFormat( &quot;#0.0000&quot; );

        private int testCount = 0;
        private int testRunCount = 0;
        private int testFailureCount = 0;
        private int testErrorCount = 0;
        private String testRunFailureCause = null;

        private final MavenProject project;
        /**
         * the emulator or device we are running the tests on *
         */
        private final IDevice device;

        private final String deviceLogLinePrefix;

        // junit xml report related fields
        private Document junitReport;
        private Node testSuiteNode;

        /**
         * node for the current test case for junit report
         */
        private Node currentTestCaseNode;
        /**
         * start time of current test case in millis, reset with each test start
         */
        private long currentTestCaseStartTime;

        // we track if we have problems and then report upstream
        private boolean threwException = false;
        private final StringBuilder exceptionMessages = new StringBuilder();

        public AndroidTestRunListener( MavenProject project, IDevice device )
        {
            this.project = project;
            this.device = device;
            this.deviceLogLinePrefix = DeviceHelper.getDeviceLogLinePrefix( device );
        }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/AbstractInstrumentationMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/AbstractInstrumentationMojo.html#L909">909</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L857">857</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L795">795</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L767">767</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>        public void testRunEnded( long elapsedTime, Map&lt;String, String&gt; runMetrics )
        {
            getLog().info( deviceLogLinePrefix + INDENT + &quot;Run ended: &quot; + elapsedTime + &quot; ms&quot; );
            if ( hasFailuresOrErrors() )
            {
                getLog().error( deviceLogLinePrefix + INDENT + &quot;FAILURES!!!&quot; );
            }
            getLog().info( INDENT + &quot;Tests run: &quot; + testRunCount
                    + ( testRunCount &lt; testCount ? &quot; (of &quot; + testCount + &quot;)&quot; : &quot;&quot; )
                    + &quot;,  Failures: &quot; + testFailureCount + &quot;,  Errors: &quot; + testErrorCount );
            if ( parsedCreateReport )
            {
                NamedNodeMap testSuiteAttributes = testSuiteNode.getAttributes();

                Attr testCountAttr = junitReport.createAttribute( ATTR_TESTSUITE_TESTS );
                testCountAttr.setValue( Integer.toString( testCount ) );
                testSuiteAttributes.setNamedItem( testCountAttr );

                Attr testFailuresAttr = junitReport.createAttribute( ATTR_TESTSUITE_FAILURES );
                testFailuresAttr.setValue( Integer.toString( testFailureCount ) );
                testSuiteAttributes.setNamedItem( testFailuresAttr );

                Attr testErrorsAttr = junitReport.createAttribute( ATTR_TESTSUITE_ERRORS );
                testErrorsAttr.setValue( Integer.toString( testErrorCount ) );
                testSuiteAttributes.setNamedItem( testErrorsAttr );

                Attr timeAttr = junitReport.createAttribute( ATTR_TESTSUITE_TIME );
                timeAttr.setValue( timeFormatter.format( elapsedTime / 1000.0 ) );
                testSuiteAttributes.setNamedItem( timeAttr );

                Attr timeStampAttr = junitReport.createAttribute( ATTR_TESTSUITE_TIMESTAMP );
                timeStampAttr.setValue( new Date().toString() );
                testSuiteAttributes.setNamedItem( timeStampAttr );
            }

            logMetrics( runMetrics );

            if ( parsedCreateReport )
            {
                writeJunitReportToFile();
            }
        }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L997">997</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L935">935</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L917">917</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>                        .append( DeviceHelper.getDescriptiveName( device ) ).append( &quot;.xml&quot; ).toString();
                File reportFile = new File( fileName );
                writer = new FileWriter( reportFile );
                Result result = new StreamResult( writer );

                xformer.transform( source, result );
                getLog().info( deviceLogLinePrefix + &quot;Report file written to &quot; + reportFile.getAbsolutePath() );
            }
            catch ( IOException e )
            {
                threwException = true;
                exceptionMessages.append( &quot;Failed to write test report file&quot; );
                exceptionMessages.append( e.getMessage() );
            }
            catch ( TransformerException e )
            {
                threwException = true;
                exceptionMessages.append( &quot;Failed to transform document to write to test report file&quot; );
                exceptionMessages.append( e.getMessage() );
            }
            finally
            {
                IOUtils.closeQuietly( writer );
            }
        }

        /**
         * Log all the metrics out in to key: value lines.
         * 
         * @param metrics
         */
        private void logMetrics( Map&lt; String, String &gt; metrics )
        {
            for ( Map.Entry&lt; String, String &gt; entry : metrics.entrySet() )
            {
                getLog().info( deviceLogLinePrefix + INDENT + INDENT + entry.getKey() + &quot;: &quot; + entry.getValue() );
            }
        }

        /**
         * @return if any failures or errors occurred in the test run.
         */
        public boolean hasFailuresOrErrors()
        {
            return testErrorCount &gt; 0 || testFailureCount &gt; 0;
        }

        /**
         * @return if the test run itself failed - a failure in the test infrastructure, not a test failure.
         */
        public boolean testRunFailed()
        {
            return testRunFailureCause != null;
        }

        /**
         * @return the cause of test failure if any.
         */
        public String getTestRunFailureCause()
        {
            return testRunFailureCause;
        }

        /**
         * @return if any exception was thrown during the test run on the build system (not the Android device or
         *         emulator)
         */
        public boolean threwException()
        {
            return threwException;
        }

        /**
         * @return all exception messages thrown during test execution on the test run time (not the Android device or
         *         emulator)
         */
        public String getExceptionMessages()
        {
            return exceptionMessages.toString();
        }
    }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/AbstractInstrumentationMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/AbstractInstrumentationMojo.html#L1051">1051</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L917">917</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>                        .append( DeviceHelper.getDescriptiveName( device ) ).append( &quot;.xml&quot; ).toString();
                File reportFile = new File( fileName );
                writer = new FileWriter( reportFile );
                Result result = new StreamResult( writer );

                xformer.transform( source, result );
                getLog().info( deviceLogLinePrefix + &quot;Report file written to &quot; + reportFile.getAbsolutePath() );
            }
            catch ( IOException e )
            {
                threwException = true;
                exceptionMessages.append( &quot;Failed to write test report file&quot; );
                exceptionMessages.append( e.getMessage() );
            }
            catch ( TransformerException e )
            {
                threwException = true;
                exceptionMessages.append( &quot;Failed to transform document to write to test report file&quot; );
                exceptionMessages.append( e.getMessage() );
            }
            finally
            {
                IOUtils.closeQuietly( writer );
            }
        }

        /**
         * Log all the metrics out in to key: value lines.
         *
         * @param metrics
         */
        private void logMetrics( Map&lt;String, String&gt; metrics )
        {
            for ( Map.Entry&lt;String, String&gt; entry : metrics.entrySet() )
            {
                getLog().info( deviceLogLinePrefix + INDENT + INDENT + entry.getKey() + &quot;: &quot; + entry.getValue() );
            }
        }

        /**
         * @return if any failures or errors occurred in the test run.
         */
        public boolean hasFailuresOrErrors()
        {</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/AbstractInstrumentationMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/AbstractInstrumentationMojo.html#L846">846</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L756">756</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L694">694</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>        public void testFailed( TestFailure status, TestIdentifier testIdentifier, String trace )
        {
            if ( status == ERROR )
            {
                ++ testErrorCount;
            }
            else
            {
                ++ testFailureCount;
            }
            getLog().info( deviceLogLinePrefix + INDENT + INDENT + status.name() + &quot;:&quot; + testIdentifier.toString() );
            getLog().info( deviceLogLinePrefix + INDENT + INDENT + trace );

            if ( parsedCreateReport )
            {
                Node errorFailureNode;
                NamedNodeMap errorfailureAttributes;
                if ( status == ERROR )
                {
                    errorFailureNode = junitReport.createElement( TAG_ERROR );
                    errorfailureAttributes = errorFailureNode.getAttributes();
                }
                else
                {
                    errorFailureNode = junitReport.createElement( TAG_FAILURE );
                    errorfailureAttributes = errorFailureNode.getAttributes();
                }

                errorFailureNode.setTextContent( trace );

                Attr msgAttr = junitReport.createAttribute( ATTR_MESSAGE );
                msgAttr.setValue( parseForMessage( trace ) );
                errorfailureAttributes.setNamedItem( msgAttr );

                Attr typeAttr = junitReport.createAttribute( ATTR_TYPE );
                typeAttr.setValue( parseForException( trace ) );
                errorfailureAttributes.setNamedItem( typeAttr );

                currentTestCaseNode.appendChild( errorFailureNode );
            }
        }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/AbstractInstrumentationMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/AbstractInstrumentationMojo.html#L848">848</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L668">668</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>            if ( status == ERROR )
            {
                ++ testErrorCount;
            }
            else
            {
                ++ testFailureCount;
            }
            getLog().info( deviceLogLinePrefix + INDENT + INDENT + status.name() + &quot;:&quot; + testIdentifier.toString() );
            getLog().info( deviceLogLinePrefix + INDENT + INDENT + trace );

            if ( parsedCreateReport )
            {
                Node errorFailureNode;
                NamedNodeMap errorfailureAttributes;
                if ( status == ERROR )
                {
                    errorFailureNode = junitReport.createElement( TAG_ERROR );
                    errorfailureAttributes = errorFailureNode.getAttributes();
                }
                else
                {
                    errorFailureNode = junitReport.createElement( TAG_FAILURE );
                    errorfailureAttributes = errorFailureNode.getAttributes();
                }

                errorFailureNode.setTextContent( trace );

                Attr msgAttr = junitReport.createAttribute( ATTR_MESSAGE );
                msgAttr.setValue( parseForMessage( trace ) );
                errorfailureAttributes.setNamedItem( msgAttr );

                Attr typeAttr = junitReport.createAttribute( ATTR_TYPE );
                typeAttr.setValue( parseForException( trace ) );
                errorfailureAttributes.setNamedItem( typeAttr );

                currentTestCaseNode.appendChild( errorFailureNode );
            }
        }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L528">528</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L378">378</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>                    monkeyTestRunner.run( testRunListener );
                    if ( testRunListener.hasFailuresOrErrors() &amp;&amp; !isIgnoreTestFailures() )
                    {
                        throw new MojoFailureException( deviceLogLinePrefix + &quot;Tests failed on device.&quot; );
                    }
                    if ( testRunListener.testRunFailed() )
                    {
                        throw new MojoFailureException( deviceLogLinePrefix + &quot;Test run failed to complete: &quot;
                                + testRunListener.getTestRunFailureCause() );
                    }
                    if ( testRunListener.threwException() &amp;&amp; !isIgnoreTestFailures() )
                    {
                        throw new MojoFailureException( deviceLogLinePrefix + testRunListener.getExceptionMessages() );
                    }
                }
                catch ( TimeoutException e )
                {
                    throw new MojoExecutionException( deviceLogLinePrefix + &quot;timeout&quot;, e );
                }
                catch ( AdbCommandRejectedException e )
                {
                    throw new MojoExecutionException( deviceLogLinePrefix + &quot;adb command rejected&quot;, e );
                }
                catch ( ShellCommandUnresponsiveException e )
                {
                    throw new MojoExecutionException( deviceLogLinePrefix + &quot;shell command &quot; + &quot;unresponsive&quot;, e );
                }
                catch ( IOException e )
                {
                    throw new MojoExecutionException( deviceLogLinePrefix + &quot;IO problem&quot;, e );
                }
            }
        };</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/AbstractInstrumentationMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/AbstractInstrumentationMojo.html#L821">821</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L733">733</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L671">671</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L634">634</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>        public void testStarted( TestIdentifier testIdentifier )
        {
            testRunCount++;
            getLog().info( deviceLogLinePrefix 
                    + String.format( &quot;%1$s%1$sStart [%2$d/%3$d]: %4$s&quot;, INDENT, testRunCount, testCount,
                    testIdentifier.toString() ) );

            if ( parsedCreateReport )
            {
                // reset start time for each test run
                currentTestCaseStartTime = new Date().getTime();

                currentTestCaseNode = junitReport.createElement( TAG_TESTCASE );
                NamedNodeMap testCaseAttributes = currentTestCaseNode.getAttributes();

                Attr classAttr = junitReport.createAttribute( ATTR_TESTCASE_CLASSNAME );
                classAttr.setValue( testIdentifier.getClassName() );
                testCaseAttributes.setNamedItem( classAttr );

                Attr methodAttr = junitReport.createAttribute( ATTR_TESTCASE_NAME );
                methodAttr.setValue( testIdentifier.getTestName() );
                testCaseAttributes.setNamedItem( methodAttr );
            }
        }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/AbstractInstrumentationMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/AbstractInstrumentationMojo.html#L888">888</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyMojo.html#L836">836</a></td></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/MonkeyRunnerMojo.html#L774">774</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L746">746</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>        public void testEnded( TestIdentifier testIdentifier, Map&lt;String, String&gt; testMetrics )
        {
            getLog().info( deviceLogLinePrefix 
                    + String.format( &quot;%1$s%1$sEnd [%2$d/%3$d]: %4$s&quot;, INDENT, testRunCount, testCount,
                    testIdentifier.toString() ) );
            logMetrics( testMetrics );

            if ( parsedCreateReport )
            {
                testSuiteNode.appendChild( currentTestCaseNode );
                NamedNodeMap testCaseAttributes = currentTestCaseNode.getAttributes();

                Attr timeAttr = junitReport.createAttribute( ATTR_TESTCASE_TIME );

                long now = new Date().getTime();
                double seconds = ( now - currentTestCaseStartTime ) / 1000.0;
                timeAttr.setValue( timeFormatter.format( seconds ) );
                testCaseAttributes.setNamedItem( timeAttr );
            }
        }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/AbstractInstrumentationMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/AbstractInstrumentationMojo.html#L407">407</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/standalonemojos/UIAutomatorMojo.html#L388">388</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>                    if ( testRunListener.threwException() )
                    {
                        throw new MojoFailureException( deviceLogLinePrefix +  testRunListener.getExceptionMessages() );
                    }
                }
                catch ( TimeoutException e )
                {
                    throw new MojoExecutionException( deviceLogLinePrefix + &quot;timeout&quot;, e );
                }
                catch ( AdbCommandRejectedException e )
                {
                    throw new MojoExecutionException( deviceLogLinePrefix + &quot;adb command rejected&quot;, e );
                }
                catch ( ShellCommandUnresponsiveException e )
                {
                    throw new MojoExecutionException( deviceLogLinePrefix + &quot;shell command &quot; + &quot;unresponsive&quot;, e );
                }
                catch ( IOException e )
                {
                    throw new MojoExecutionException( deviceLogLinePrefix + &quot;IO problem&quot;, e );
                }
            }
        };

        instrumentationTestExecutor = new ScreenshotServiceWrapper( instrumentationTestExecutor, project, getLog() );

        doWithDevices( instrumentationTestExecutor );
    }

    private void addAllInstrumentationArgs(</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/phase09package/AarMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/phase09package/AarMojo.html#L328">328</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/phase09package/ApklibMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/phase09package/ApklibMojo.html#L317">317</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>    protected void addSharedLibraries( ZipArchiver zipArchiver, File directory, String architecture )
    {
        getLog().debug( &quot;Searching for shared libraries in &quot; + directory );
        File[] libFiles = directory.listFiles( new FilenameFilter()
        {
            public boolean accept( final File dir, final String name )
            {
                return name.startsWith( &quot;lib&quot; ) &amp;&amp; name.endsWith( &quot;.so&quot; );
            }
        } );

        if ( libFiles != null )
        {
            for ( File libFile : libFiles )
            {
                String dest = NATIVE_LIBRARIES_FOLDER + &quot;/&quot; + architecture + &quot;/&quot; + libFile.getName();
                getLog().debug( &quot;Adding &quot; + libFile + &quot; as &quot; + dest );</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>com/jayway/maven/plugins/android/phase09package/ApkMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/phase09package/ApkMojo.html#L867">867</a></td></tr>
<tr class="b">
<td>com/jayway/maven/plugins/android/phase09package/ApklibMojo.java</td>
<td><a href="./xref/com/jayway/maven/plugins/android/phase09package/ApklibMojo.html#L336">336</a></td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>        }
    }


    /**
     * Generates an intermediate apk file (actually .ap_) containing the resources and assets.
     *
     * @throws MojoExecutionException
     */
    private void generateIntermediateApk() throws MojoExecutionException
    {
        CommandExecutor executor = CommandExecutor.Factory.createDefaultCommmandExecutor();
        executor.setLogger( this.getLog() );
        File[] overlayDirectories = getResourceOverlayDirectories();

        File androidJar = getAndroidSdk().getAndroidJar();
        File outputFile = new File( project.getBuild().getDirectory(), project.getBuild().getFinalName() + &quot;.ap_&quot; );

        List&lt;File&gt; dependencyArtifactResDirectoryList = new ArrayList&lt;File&gt;();
        for ( Artifact libraryArtifact : getTransitiveDependencyArtifacts( APKLIB, AAR ) )
        {
            final File libraryResDir = getUnpackedLibResourceFolder( libraryArtifact );</pre></div></td></tr></table></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2008-2014
                        <a href="http://www.simpligility.com">simpligility technologies inc.</a>.
            All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
